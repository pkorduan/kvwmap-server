#!/bin/bash

function install_service() {
  if [ -z $NETWORK_NAME ] ; then
    echo "Abbruch: Kein Netzwerkname angegeben!"
  else
    if [ ! -d "$USER_DIR/networks/proxy/services/proxy" ]; then
      echo "Der Proxy fehlt! Wird installiert."
      dcm proxy create
    fi

    NETWORK_DIR=${USER_DIR}/networks/${NETWORK_NAME}
    if [ ! -d "$NETWORK_DIR" ]; then
      echo "Netzwerk ${NETWORK_NAME} existiert noch nicht. Erzeuge Netzwerk ${NETWORK_NAME}"
      dcm create network $NETWORK_NAME
    fi

    echo "Zur Einrichtung des MySQL und phpMyAdmin Containers müssen Passwörter vergeben werden!"
    if [ -z "${MYSQL_ROOT_PASSWORD}" ]; then
      read -p "mysql Root Passwort: " -s MYSQL_ROOT_PASSWORD
    else
      echo "Use pre-defined MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:1:5}..."
    fi
    echo "MYSQL_ROOT_PASSWORD=\"${MYSQL_ROOT_PASSWORD}\"" >> ${USER_DIR}/networks/${NETWORK_NAME}/env

    if [ -z "$MYSQL_USER" ]; then
      #read -p "mysql User Name: " MYSQL_USER
      MYSQL_USER="kvwmap"
      echo "MYSQL_USER=\"${MYSQL_USER}\"" >> ${USER_DIR}/networks/${NETWORK_NAME}/env
    fi

    if [ -z "$MYSQL_PASSWORD" ]; then
      echo ""
      read -p "Passwort für mysql User ${MYSQL_USER}: " -s MYSQL_PASSWORD

    else
      echo "Use pre-defined MYSQL_PASSWORD: ${MYSQL_PASSWORD:1:5}... for user ${MYSQL_USER}"
    fi
    echo "MYSQL_PASSWORD=\"${MYSQL_PASSWORD}\"" >> ${USER_DIR}/networks/${NETWORK_NAME}/env

    dcm create service web ${NETWORK_NAME}
    dcm create service mariadb ${NETWORK_NAME}
    dcm create service phpmyadmin ${NETWORK_NAME}
    dcm create service pgsql ${NETWORK_NAME}
    dcm create service gdal ${NETWORK_NAME}

    SERVICE_NAME="kvwmap-server"
  fi
}
